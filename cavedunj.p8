pico-8 cartridge // http://www.pico-8.com
version 36
__lua__

function _init()
	genmap(mapsize/2,mapsize*0.75)
end

function _update()
	movx,movy=
	axisinput(1,0),axisinput(3,2)
	
	if movx != 0 then
		movy = 0
	end
	
	if	player.yface != movx then
		movy -= movx
	end
	
	if btnp(5) or 
				(movy!=0 and
				 movy!=player.yface) then
		player.yface *= -1
	end
	
	moved=false
	moved=move(player,movx,movy)
		
	if not moved and movx!=0 then
		moved=move(player,movx,movy-player.yface)
	end
	
	if moved then
		updatemap()
	end
	
	camx,camy = entscreenpos(player)
 centerx,centery = screenpos(mapcenter,mapcenter,-3,-7)
	camx = camx*0.5 + centerx*0.5
	camy = camy*0.5 + centery*0.5
	camera(camx-64,camy-64)
end

function _draw()
	cls()
	palt(0, false)
	palt(15, true)
	drawmap(world)
end
-->8
tempty,tcavefloor,tcavewall=
0     ,178       ,128
tdunjfloor,tdunjwall=
176       ,130

function tile(typ)
	tl = {typ=typ}
	return tl
end
-->8
mapsize,mapcenter=
20     ,10

function inbounds(x,y)
	return x>0 and
							 x<mapsize and
								y>0  and
								y<mapsize and
								x+y>mapcenter and
								x+y<mapsize*1.5
end

adj={{0,-1},
					{1,-1},
					{1, 0},
					{0, 1},
					{-1,1},
					{-1,0}}

function visitadj(x,y,func)
	offset = flr(rnd(6))
	for i = offset,offset+6 do
		coord = adj[i%6+1]
		nx = x+coord[1]
		ny = y+coord[2]
		func(nx,ny,world[nx][ny])
	end
end

p=2

function alltiles(func)
	for x=0,mapsize do
		for y=0,mapsize do
			func(x,y,world[x][y])
		end
	end
end

function drawmap()
	alltiles(function(x,y,tile)
		typ = tile.typ
		if typ > 0 then 
			scrx,scry=screenpos(x,y,-7,-4)
			fillp(tile.light>0 and █	or
								 0x3c68|0.25)
			spr(world[x][y].typ,scrx,scry,2,1)
		end
	end)
	fillp(█)
	alltiles(function(x,y,tile)
		ent = tile.ent
		if ent then
			scrx,scry=entscreenpos(ent)
			spr(ent.typ + (ent.yface > 0 and 16 or 0),scrx,scry,0.875,1,ent.xface<0)
		end
	end)
end

function navigable(x,y)
	return world[x][y].typ >= tdunjfloor
end

function passlight(x,y)
	return world[x][y].typ >= tdunjfloor
end

function updatemap()
	alltiles(
	function(x,y)
		tile = world[x][y]
		ent = tile.ent
		tile.light = ent and ent.light or 0
	end)
	for i = 4,0,-1 do
		alltiles(
		function(x,y,tile)
			if passlight(x,y) and
				tile.light == i then
				visitadj(x,y,
				function(nx,ny,tln)
					tln.light=max(
						tln.light,
						i-1)
				end)
			end
		end)
	end
end
-->8
function screenpos(x,y,
																			offsetx,
																			offsety)
	return offsetx + x*10,
							 offsety + y*8 + x*4 
end

function entscreenpos(ent)
	return screenpos(ent.x,ent.y,
																		-3,-7)
end

function axisinput(pos,neg)
	return tonum(btnp(pos))-
								tonum(btnp(neg))
end

-->8
eplayer,egoblin=
1      ,2

function create(typ,x,y)
	ent = {typ=typ,x=x,y=y,
							xface=1,yface=-1}
		
	add(ents,ent)
	world[x][y].ent = ent
	return ent
end

function move(ent,x,y)
	dstx,dsty=ent.x+x,ent.y+y
	if not navigable(dstx,dsty) then
		return false
	end
	world[ent.x][ent.y].ent = nil
	ent.x,ent.y=dstx,dsty
	if x != 0 then 
		ent.xface = x
 end
 if y != 0 then
 	ent.yface = y
 elseif x != 0 then
  ent.yface = x
 end
	
	world[ent.x][ent.y].ent = ent
	return true
end
-->8
function genmap(startx,starty)
	printh("genmap()")
	world={}
	ents={}
	for x=0,mapsize do
	 world[x] = {}
		for y=0,mapsize do
			--world[x][y] = tile(tcavefloor*
			--																inbounds(x,y))
			world[x][y] = tile(tempty)
		end
	end
	world[startx][starty] = tile(tcavefloor)
	gen(startx,starty)
	player = create(eplayer,
																	startx,starty)
	player.light=4
	updatemap()
end

function gen(x,y)
	typ = world[x][y].typ
	p -= 0.02
	if typ == tcavefloor then
		visitadj(x,y,
		function(nx,ny,tl)
			if tl.typ == tempty then
				if inbounds(nx,ny) and 
							rnd()<p then
					tl.typ=tcavefloor
					gen(nx,ny)
				else
					tl.typ=tcavewall
				end
			end
		end) 
	end
end
__gfx__
fffffffffff67fffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
f5ffff5ffff62f9fffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ff5ff5ffff888faffff3f3ff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
fff55fffff88df4fff533fff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
fff55fffff88d6ffff555ff600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ff5ff5ffff882fffff555f6f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
f5ffff5fff2f2fffff4453ff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ffffffffffdfdfffff4f4fff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
fffffffffff67fff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
fffffffffff22fff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ffffffffff882f9f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
f00000ffff86dfaf0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ff000fffff8d6f4f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ffffffffff8226ff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ffffffffff2f2fff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ffffffffffdfdfff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
fffff0000000ffffffffff000fffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000
ff00000100000ffffffff000000dfffffffff000ffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000
f0100101501000ffffff0000001dffffffff000000ffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000
f0100501501050fffff000000d11fffffff0000000000fff00000000000000000000000000000000000000000000000000000000000000000000000000000000
01d105011000500fff000000dd11ffffff5500000000001f00000000000000000000000000000000000000000000000000000000000000000000000000000000
11d101051050000ff0000001d1d1ffffff55055000000d1f00000000000000000000000000000000000000000000000000000000000000000000000000000000
d1d101000010050f055000d11dd1ffffff0005505500dd1f00000000000000000000000000000000000000000000000000000000000000000000000000000000
dd1000000000050f05550dd11d1dffffff0550005550d1df00000000000000000000000000000000000000000000000000000000000000000000000000000000
1d1000111100000f00050d1d111dffffff05550000501ddf00000000000000000000000000000000000000000000000000000000000000000000000000000000
d10011111111000f005001dd1d10ffffff00050550001d1f00000000000000000000000000000000000000000000000000000000000000000000000000000000
d00101111001100f005551d1dd0fffffff5500055055111f00000000000000000000000000000000000000000000000000000000000000000000000000000000
001111111111100f00055111d0ffffffff55055000551d1f00000000000000000000000000000000000000000000000000000000000000000000000000000000
f0101001111010ff055001d10fffffffff0005505500dd0f00000000000000000000000000000000000000000000000000000000000000000000000000000000
ff00111110100fff05550dd0fffffffffffff0005550d0ff00000000000000000000000000000000000000000000000000000000000000000000000000000000
fff000010000ffff00050d0ffffffffffffffff000500fff00000000000000000000000000000000000000000000000000000000000000000000000000000000
ffff0000000ffffffff000ffffffffffffffffffff00ffff00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ffff0000000fffffffff0000000fffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
fff001101100fffffff011111110ffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ff00111100110fffff01111111110fff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
f0110110110110fff0111111100110ff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
011110011110010f011111111111110f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
f0110110110110fff0111001111110ff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ff00111100110fffff01111111110fff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
fff001101100fffffff011111110ffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ffff0000000fffffff05441111501ddf000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
fff011111110ffffff00041441001d1f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ff01114441110fffff5501144145111f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
f0114444444110ffff55044111551d1f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
011444444444110fff0005504400dd0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
f0114444444110fffffff0005550d0ff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ff01114441110ffffffffff000500fff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
fff011111110ffffffffffffff00ffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
fffff0010100ffffffffff000fffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ff00011141100ffffffff000000dffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
f0101114454110ffffff0000001dffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
f0101454454140fffff000000d11ffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
019114544001410fff000000d911ffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
119115141151411ff00000019191ffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d19111111111141f055000d11991ffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d91000000000141f05550d91191dffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
191011111111011f00050d19111dffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d10111444411101f005001991910ffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d01114444441110f005551919d0fffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001144444444110f00055111d0ffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
f0101444444010ff055001d10fffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ff00114444100fff05550dd0ffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
fff000010000ffff00050d0fffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ffff0000000ffffffff000ffffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
